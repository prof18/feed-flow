app-id: com.prof18.feedflow
runtime: org.freedesktop.Platform
runtime-version: '24.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.openjdk21
command: feedflow
finish-args:
  - --share=network
  - --share=ipc
  - --socket=x11
  - --device=dri
  - --filesystem=xdg-download:rw

modules:
  - name: jbr
    buildsystem: simple
    build-commands:
      - mkdir -p /app/jre
      - tar xzf jbr-*.tar.gz -C /app/jre --strip-components=1
    sources:
      - type: file
        url: https://cache-redirector.jetbrains.com/intellij-jbr/jbr-21.0.10-linux-x64-b1163.105.tar.gz
        sha256: b6a3b13451d296140727bbde9325dd9ee422e2e9b2c6a9378f346f1b8d1111bc
        only-arches:
          - x86_64
      - type: file
        url: https://cache-redirector.jetbrains.com/intellij-jbr/jbr-21.0.10-linux-aarch64-b1163.105.tar.gz
        sha256: 38804f526d869f5a9c49e9b90c04edcbc918b41e8e43264e5d5076d352a959bc
        only-arches:
          - aarch64

  - name: feedflow
    buildsystem: simple
    build-options:
      append-path: "/usr/lib/sdk/openjdk21/bin"
    build-commands:
      - ./.scripts/flatpak-build-setup.sh
      - ./.scripts/disable-android-for-flatpak.sh
      - ./gradlew desktopApp:packageReleaseUberJarForCurrentOS --no-daemon --offline -Dorg.gradle.jvmargs="-Xmx6g -XX:MaxMetaspaceSize=2g" -Dorg.gradle.daemon=true -Dorg.gradle.parallel=false --no-configuration-cache
      - JAR_FILE=$(find desktopApp/build/compose/jars/ -name "*.jar" -type f | head -1) && install -Dm755 "$JAR_FILE" /app/lib/feedflow.jar
      - install -Dm644 desktopApp/packaging/flatpak/com.prof18.feedflow.desktop /app/share/applications/com.prof18.feedflow.desktop
      - install -Dm644 desktopApp/packaging/flatpak/com.prof18.feedflow.metainfo.xml /app/share/metainfo/com.prof18.feedflow.metainfo.xml
      - install -Dm644 desktopApp/packaging/flatpak/com.prof18.feedflow.png /app/share/icons/hicolor/512x512/apps/com.prof18.feedflow.png
      - mkdir -p /app/bin
      - install -Dm755 desktopApp/packaging/flatpak/feedflow.sh /app/bin/feedflow
    sources:
      - type: git
        url: https://github.com/prof18/feed-flow
        tag: 1.9.0-all
      - type: file
        url: "https://services.gradle.org/distributions/gradle-9.1.0-bin.zip"
        sha256: "a17ddd85a26b6a7f5ddb71ff8b05fc5104c0202c6e64782429790c933686c806"
        dest: "gradle/wrapper"
        dest-filename: "gradle-bin.zip"
      - flatpak-sources.json
      - flatpak-sources-convention.json
      - flatpak-sources-manual.json
      - flatpak-sources-manual2.json
      - flatpak-sources-root.json