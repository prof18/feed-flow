app-id: com.prof18.feedflow
runtime: org.freedesktop.Platform
runtime-version: '24.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.openjdk21
command: feedflow
finish-args:
  - --share=network
  - --share=ipc
  - --socket=x11
  - --socket=wayland
  - --device=dri
  - --filesystem=xdg-documents:ro
  - --filesystem=xdg-download:rw

modules:
  - name: openjdk
    buildsystem: simple
    build-commands:
      - /usr/lib/sdk/openjdk21/install.sh
    cleanup:
      - /jre/lib/src.zip

  - name: feedflow
    buildsystem: simple
    build-options:
      build-args:
        - --share=network
    build-commands:
      - echo "is_release=true" >> desktopApp/src/jvmMain/resources/props.properties
      - echo "version=1.3.0" >> desktopApp/src/jvmMain/resources/props.properties
      - . /usr/lib/sdk/openjdk21/enable.sh && ./gradlew desktopApp:packageReleaseUberJarForCurrentOS -Dorg.gradle.jvmargs="-Xmx6g -XX:MaxMetaspaceSize=2g" -Dorg.gradle.daemon=true -Dorg.gradle.parallel=false --offline
      - ls -la desktopApp/build/compose/jars/ || echo "Directory doesn't exist"
      - JAR_FILE=$(find desktopApp/build/compose/jars/ -name "*.jar" -type f | head -1) && install -Dm755 "$JAR_FILE" /app/lib/feedflow.jar
      - install -Dm644 desktopApp/packaging/flatpak/com.prof18.feedflow.desktop /app/share/applications/com.prof18.feedflow.desktop
      - install -Dm644 desktopApp/packaging/flatpak/com.prof18.feedflow.metainfo.xml /app/share/metainfo/com.prof18.feedflow.metainfo.xml
      - install -Dm644 desktopApp/packaging/flatpak/com.prof18.feedflow.png /app/share/icons/hicolor/512x512/apps/com.prof18.feedflow.png
      - mkdir -p /app/bin
      - |
        cat > /app/bin/feedflow << 'EOF'
        #!/bin/bash
        export JAVA_HOME=/app/jre
        exec /app/jre/bin/java -Djava.awt.headless=false -Dawt.useSystemAAFontSettings=on -Dswing.aatext=true -jar /app/lib/feedflow.jar "$@"
        EOF
      - chmod +x /app/bin/feedflow
    sources:
      - type: git
        url: https://github.com/prof18/feed-flow
        commit: f2a84586390c59e7df231bd3becd889df6a9ffde
      - flatpak-sources.json